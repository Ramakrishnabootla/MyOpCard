<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - MyOpCard</title>
  <link rel="stylesheet" href="./shared/base.css" />
  <script defer src="./shared/ui.js"></script>
  <link rel="stylesheet" href="./auth/auth.css" />
  <script defer src="./auth/auth.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    async function api(path, options={}) {
      const res = await fetch(`${API_BASE}${path}`, { method: options.method||'GET', headers:{'Content-Type':'application/json'}, credentials:'include', body: options.body?JSON.stringify(options.body):undefined });
      let data=null; try{ data=await res.json(); }catch(_){ }
      if(!res.ok) throw new Error(data?.error || data?.errors?.[0]?.msg || 'Request failed');
      return data;
    }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('toast','show'); setTimeout(()=>t.classList.remove('show'),2000); }
    function closeModal(){ document.getElementById('apptModal').style.display='none'; }
    function openModal(){ document.getElementById('apptModal').style.display='block'; }
    async function loadDoctors(){ const sel=document.getElementById('doctor'); sel.innerHTML=''; const docs=await api('/appointments/doctors'); for(const d of docs){ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; sel.appendChild(o);} }
    async function loadAvailability(){ const doctorId=document.getElementById('doctor').value; const date=document.getElementById('date').value; const timeSel=document.getElementById('time'); timeSel.innerHTML=''; if(!doctorId||!date) return; const slots=await api(`/appointments/availability?doctorId=${encodeURIComponent(doctorId)}&date=${encodeURIComponent(date)}`); for(const s of slots){ const d=new Date(s.time); const opt=document.createElement('option'); opt.value=d.toISOString(); opt.textContent=d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); opt.disabled=!s.available; timeSel.appendChild(opt);} }
    async function submitBooking(e){ e.preventDefault(); const doctorId=document.getElementById('doctor').value; const time=document.getElementById('time').value; const type=document.querySelector('input[name="type"]:checked')?.value; if(!doctorId||!time||!type){ showToast('Please fill all fields'); return; } if(!confirm('Confirm this appointment?')) return; try{ await api('/appointments/create',{ method:'POST', body:{ doctorId, dateTime: time, type }}); closeModal(); showToast('Appointment booked'); loadUpcoming(); }catch(err){ showToast(err.message);} }
    async function loadUpcoming(){ const list=document.getElementById('upcoming'); list.innerHTML=''; try{ const items=await api('/appointments/upcoming'); if(items.length===0){ list.innerHTML='<p class="muted">No upcoming appointments</p>'; return; } for(const it of items){ const li=document.createElement('div'); li.className='card'; li.style.marginBottom='.6rem'; li.innerHTML=`<div class="row" style="justify-content:space-between; align-items:center; gap:.5rem;"><div><div class="title" style="margin:0 0 .25rem 0; font-size:1rem;">${it.doctorId} â€¢ ${it.type}</div><div class="muted">${new Date(it.dateTime).toLocaleString()}</div></div><div><button class="btn secondary" data-cancel="${it._id}">Cancel</button></div></div>`; list.appendChild(li);} }catch(err){ list.innerHTML=`<div class="card">${err.message}</div>`; } }
    async function cancelAppt(id){ if(!confirm('Cancel this appointment?')) return; try{ await api(`/appointments/${id}/cancel`,{ method:'POST' }); showToast('Cancelled'); loadUpcoming(); }catch(err){ showToast(err.message);} }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('logout').addEventListener('click', async () => { try { await Auth.logout(); } catch(_){} });
      document.getElementById('book').addEventListener('click', async ()=>{ openModal(); await loadDoctors(); await loadAvailability(); });
      document.getElementById('closeAppt').addEventListener('click', closeModal);
      document.getElementById('doctor').addEventListener('change', loadAvailability);
      document.getElementById('date').addEventListener('change', loadAvailability);
      document.getElementById('apptForm').addEventListener('submit', submitBooking);
      document.getElementById('upcoming').addEventListener('click', (e)=>{ const btn=e.target.closest('button[data-cancel]'); if(btn) cancelAppt(btn.getAttribute('data-cancel')); });
      loadUpcoming();
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="title">Welcome to your dashboard</h1>
      <p class="muted">You are logged in.</p>
      <div class="row">
        <a class="btn secondary" href="/frontend/opcards/index.html">Manage OP Cards</a>
        <a class="btn secondary" href="/frontend/opbooking/opbooking.html">Appointments</a>
        <button id="logout" class="btn">Logout</button>
      </div>
    </div>
    <div class="card" style="margin-top:1rem;">
      <div class="row" style="justify-content: space-between; align-items:center;">
        <div class="title" style="margin:0;">Upcoming Appointments</div>
        <button id="book" class="btn">Book Appointment</button>
      </div>
      <div id="upcoming" style="margin-top:.75rem"></div>
    </div>
  </div>

  <div id="apptModal" class="modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; padding:1rem;">
    <div class="inner" style="max-width:560px; margin:4rem auto;">
      <div class="card">
        <h3 class="title" style="margin-top:0;">Book Appointment</h3>
        <form id="apptForm">
          <div class="field">
            <label for="doctor">Doctor</label>
            <select id="doctor" required aria-label="Select Doctor"></select>
          </div>
          <div class="row">
            <div class="field" style="flex:1;">
              <label for="date">Date</label>
              <input type="date" id="date" required />
            </div>
            <div class="field" style="flex:1;">
              <label for="time">Time</label>
              <select id="time" required aria-label="Select time slot"></select>
            </div>
          </div>
          <div class="field">
            <label>Visit Type</label>
            <div class="row">
              <label><input type="radio" name="type" value="Physical" required /> Physical</label>
              <label><input type="radio" name="type" value="Video" required /> Video</label>
            </div>
          </div>
          <div class="row">
            <button class="btn" type="submit">Confirm Booking</button>
            <button class="btn secondary" id="closeAppt" type="button">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>
</body>
</html>


